/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Resource allocations for each process
    Nodes: 384 CPUs, ~1.5 TB RAM each (shared)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

// check_max() replaced by inline [requested, cap].min() for v2 config parser

process {
   // --- Defaults ---
    cpus          = { [1,    params.max_cpus   as int].min() }
    memory        = { [4.GB, params.max_memory as nextflow.util.MemoryUnit].min() }
    time          = { [1.h,  params.max_time   as nextflow.util.Duration].min() }

   // Retry on OOM / SLURM memory-kill / NFS SIGBUS exit codes
    errorStrategy = { task.exitStatus in [104, 134, 135, 137, 139, 140, 143, 247] ? 'retry' : 'finish' }
    maxRetries    = 2

   // -- SortMeRNA ---------------------------------------------------------
    withName: 'SORTMERNA_INDEX' {
        cpus   = { [4, params.max_cpus as int].min() }
        memory = { [16.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time   = { [2.h, params.max_time as nextflow.util.Duration].min() }
    }
    withName: 'SORTMERNA' {
        cpus      = { [32, params.max_cpus as int].min() }
        memory    = { [64.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time      = { [8.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        maxForks  = 40
    }

   // -- Salmon initial (full Trinity, --dumpEq for Corset) -----
    withName: 'SALMON_INDEX_INITIAL' {
        cpus     = { [8, params.max_cpus as int].min() }
        memory   = { [100.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time     = { [4.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        ext.args = '--keepDuplicates'
    }
    withName: 'SALMON_QUANT_INITIAL' {
        cpus     = { [8, params.max_cpus as int].min() }
        memory   = { [64.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time     = { [8.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        ext.args = '--dumpEq'
    }

   // -- Corset + Lace ---------------------------------------------------
    withName: 'CORSET' {
        cpus       = { [32, params.max_cpus as int].min() }
        memory     = { [128.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [48.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        publishDir = [ path: "${params.outdir}/clustering", mode: 'copy' ]
    }
    withName: 'LACE' {
        cpus       = { [16, params.max_cpus as int].min() }
        memory     = { [128.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [24.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        publishDir = [ path: "${params.outdir}/supertranscripts", mode: 'copy' ]
    }

   // -- Taxonomy filter (UniRef50: ~52M seqs, ~3-4Ã— smaller than UniRef90) --
    withName: 'MMSEQS2_TAXONOMY' {
        cpus       = { [32, params.max_cpus as int].min() }
        memory     = { [[500.GB, 700.GB, 1000.GB][task.attempt - 1], params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [72.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        publishDir = [ path: "${params.outdir}/taxonomy", mode: 'copy' ]
    }

   // -- Frameshift correction --------------------------------------------
    withName: 'DIAMOND_BLASTX' {
        cpus   = { [32, params.max_cpus as int].min() }
        memory = { [300.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time   = { [72.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
    }
    withName: 'CORRECT_FRAMESHIFTS' {
        cpus       = { [1, params.max_cpus as int].min() }
        memory     = { [8.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [1.h, params.max_time as nextflow.util.Duration].min() }
        publishDir = [ path: "${params.outdir}/frameshift_correction", mode: 'copy', pattern: 'frameshift_stats.txt' ]
    }

   // -- TD2 ORF prediction -----------------------------------------------
    withName: 'TD2_LONGORFS' {
        cpus     = { [8, params.max_cpus as int].min() }
        memory   = { [16.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time     = { [2.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        ext.args = { (params.td2_strand_specific ? '-S ' : '') + "-m ${params.td2_min_orf_length}" }
    }
    withName: 'TD2_PREDICT' {
        cpus   = { [1, params.max_cpus as int].min() }
        memory = { [8.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time   = { [16.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
    }

   // -- MMseqs2 homology search (SwissProt + Pfam) -----------------------
    withName: 'MMSEQS2_SEARCH_SWISSPROT' {
        cpus       = { [16, params.max_cpus as int].min() }
        memory     = { [64.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [4.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        ext.args   = { "-s ${params.mmseqs2_search_sens}" }
        publishDir = [ path: "${params.outdir}/mmseqs2_search", mode: 'copy', pattern: '*.m8' ]
    }
    withName: 'MMSEQS2_SEARCH_PFAM' {
        cpus       = { [32, params.max_cpus as int].min() }
        memory     = { [128.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [8.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        ext.args   = { "-s ${params.mmseqs2_search_sens}" }
        publishDir = [ path: "${params.outdir}/mmseqs2_search", mode: 'copy', pattern: '*.m8' ]
    }

   // -- Best ORF selection -----------------------------------------------
    withName: 'SELECT_BEST_ORF' {
        cpus       = { [1, params.max_cpus as int].min() }
        memory     = { [4.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [30.min, params.max_time as nextflow.util.Duration].min() }
        publishDir = [
            [ path: "${params.outdir}/proteins",   mode: 'copy', pattern: '*.faa' ],
            [ path: "${params.outdir}/annotation", mode: 'copy', pattern: '*.gff3' ],
            [ path: "${params.outdir}/annotation", mode: 'copy', pattern: '*.tsv' ]
        ]
    }

   // -- Salmon final (gene-level SuperTranscripts) -----------------------
    withName: 'SALMON_INDEX_FINAL' {
        cpus   = { [8, params.max_cpus as int].min() }
        memory = { [32.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time   = { [2.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
    }
    withName: 'SALMON_QUANT_FINAL' {
        cpus       = { [8, params.max_cpus as int].min() }
        memory     = { [32.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [8.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        ext.args   = '--dumpEq --writeOrphanLinks --rangeFactorizationBins 4'
        publishDir = [ path: "${params.outdir}/salmon_final", mode: 'copy' ]
    }

   // -- Validation & QC -------------------------------------------------
    withName: 'VALIDATE_IDS' {
        cpus   = { [1, params.max_cpus as int].min() }
        memory = { [2.GB, params.max_memory as nextflow.util.MemoryUnit].min() }
        time   = { [10.min, params.max_time as nextflow.util.Duration].min() }
    }
    withName: 'BUSCO_TRINITY' {
        cpus       = { [16, params.max_cpus as int].min() }
        memory     = { [64.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [24.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        ext.args   = { "-l ${params.busco_lineage} -m transcriptome" }
        publishDir = [ path: "${params.outdir}/qc", mode: 'copy' ]
    }
    withName: 'BUSCO_QC' {
        cpus       = { [16, params.max_cpus as int].min() }
        memory     = { [32.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [4.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        ext.args   = { "-l ${params.busco_lineage} -m proteins" }
        publishDir = [ path: "${params.outdir}/qc", mode: 'copy' ]
    }

   // -- Functional annotation -------------------------------------------
    // eggNOG7: 3.18M profiles, ~340 GB k-mer index, must fit in RAM
    withName: 'TRANSANNOT' {
        cpus       = { [16, params.max_cpus as int].min() }
        memory     = { [[500.GB, 700.GB, 1000.GB][task.attempt - 1], params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [12.h * task.attempt, params.max_time as nextflow.util.Duration].min() }
        errorStrategy = { task.exitStatus in [1, 104, 134, 135, 137, 139, 140, 143, 247] ? 'retry' : 'finish' }
        publishDir = [ path: "${params.outdir}/transannot", mode: 'copy' ]
    }

   // -- Report ----------------------------------------------------------
    withName: 'THINNING_REPORT' {
        cpus       = { [1, params.max_cpus as int].min() }
        memory     = { [16.GB * task.attempt, params.max_memory as nextflow.util.MemoryUnit].min() }
        time       = { [30.min, params.max_time as nextflow.util.Duration].min() }
        publishDir = [ path: "${params.outdir}", mode: 'copy' ]
    }

}
