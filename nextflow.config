/* nf-denovoslim — nextflow.config */

// Container images (config-only — not pipeline parameters).
// Docker format; auto-converted for Singularity/Apptainer.
params {
    sortmerna_container  = 'community.wave.seqera.io/library/sortmerna:4.3.7--b730cad73fc42b8e'
    salmon_container     = 'quay.io/biocontainers/salmon:1.10.3--h6dccd9a_2'
    mmseqs2_container    = 'quay.io/biocontainers/mmseqs2:18.8cc5c--hd6d6fdc_0'
    corset_container     = "${projectDir}/containers/corset/corset_1.10.sif"
    lace_container       = "${projectDir}/containers/lace/lace_2.0.sif"
    td2_container        = "${projectDir}/containers/td2/td2_1.0.8.sif"
    busco_container      = 'ezlabgva/busco:v6.0.0_cv1'
    transannot_container = "${projectDir}/containers/transannot/transannot_4.0.0_eggnog7.sif"
    diamond_container    = 'quay.io/biocontainers/diamond:2.1.22--h13889ed_0'
    biopython_container  = 'quay.io/biocontainers/biopython:1.81'

    // Resource caps (overridden by site configs / profiles)
    max_cpus             = 16
    max_memory           = 128.GB
    max_time             = 168.h   // 7 days

    // Output directory (default; overridden by --outdir on CLI)
    outdir               = './results'

    // --- Pipeline params used in config closures (must live here, not main.nf) ---
    // TD2 ORF prediction
    td2_min_orf_length   = 90       // -m: min ORF length (aa) for long transcripts
    td2_abs_min_orf      = 50       // -M: absolute min ORF length (aa) for short transcripts
    td2_length_scale     = 0.5      // -L: accept short ORF if it covers >= this fraction of transcript
    td2_strand_specific  = true

    // MMseqs2 search sensitivity
    mmseqs2_search_sens  = 7.0

    // Taxonomy filter (NCBI taxon ID)
    filter_taxon         = 33090         // Viridiplantae

    // Cluster / site (nullable — closures handle null via ternary)
    unix_group           = null
    orion_exclude_nodes  = null          // e.g. 'cn-37'
}

process {
    shell = ['/bin/bash', '-euo', 'pipefail']

    withName: 'SORTMERNA.*'           { container = params.sortmerna_container }
    withName: 'MMSEQS2_.*'            { container = params.mmseqs2_container }
    withName: 'SALMON_.*'             { container = params.salmon_container }
    withName: 'CORSET'                { container = params.corset_container }
    withName: 'LACE'                  { container = params.lace_container }
    withName: 'DIAMOND_BLASTX.*'      { container = params.diamond_container }
    withName: 'CORRECT_FRAMESHIFTS.*' { container = params.biopython_container }
    withName: 'TD2_.*'                { container = params.td2_container }
    withName: 'BUSCO_.*'              { container = params.busco_container }
    withName: 'TRANSANNOT'            { container = params.transannot_container }
    withName: 'SELECT_BEST_ORF'       { container = params.biopython_container }
    withName: 'VALIDATE_IDS'          { container = 'ubuntu:22.04' }
    withName: 'THINNING_REPORT'       { container = params.biopython_container }
}

// Load base resource config
includeConfig 'conf/base.config'

// Usage: -profile apptainer,orion | apptainer,slurm | docker
profiles {
    apptainer {
        apptainer.enabled     = true
        apptainer.autoMounts  = true
        apptainer.cacheDir    = "${projectDir}/singularity_cache"
        apptainer.pullTimeout = '45m'
        docker.enabled        = false
    }
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.cacheDir   = "${projectDir}/singularity_cache"
        docker.enabled         = false
    }
    slurm {
        process.executor         = 'slurm'
        executor.submitRateLimit = '30/1min'
        executor.queueSize       = 20
    }
    orion {
        // NMBU Orion HPC — loads site-specific config
        // Set params.unix_group and params.orion_exclude_nodes on CLI or in run scripts
        includeConfig 'conf/orion.config'
    }
    docker {
        docker.enabled    = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
    // Resource profiles — pick one to match your cluster
    highmem {
        // Large-memory nodes (>512 GB RAM, e.g. Orion)
        params.max_cpus   = 64
        params.max_memory = 1200.GB
        params.max_time   = 336.h
    }
    standard {
        // Mid-range cluster nodes (128-256 GB RAM)
        params.max_cpus   = 16
        params.max_memory = 128.GB
        params.max_time   = 168.h
    }
    test {
        // Minimal test run with low resources
        params.max_cpus   = 4
        params.max_memory = 16.GB
        params.max_time   = 6.h
    }
}

// --- Manifest ---
manifest {
    name            = 'nf-denovoslim'
    author          = 'Martin Paliocha'
    description     = 'Trinity assembly thinning pipeline'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=25.10.0'
    version         = '0.1.0'
}
